```{r}
suppressPackageStartupMessages({
library(tidyverse)
library(maftools)
library(vcfR)
library(dplyr)
})
```

## Exploring the gene list



# Exploring the annovar output:

```{r}
annovar_output <- read_delim("/Volumes/Extreme_SSD/Regie/annovar_keepingallcols_afterloftee_results/100.hg38_multianno.txt")

```

## Filtered clinvar matches

```{r}
annovar_output <- annovar_output %>%
    mutate(DANN_score_numeric = as.numeric(replace(DANN_score, DANN_score == ".", NA))) %>%
    mutate(across(starts_with("gnomad41_exome_AF_"), ~ replace(., . == ".", NA))) %>%
    mutate(across(starts_with("GME_"), ~ replace(., . == ".", NA))) %>%
    mutate(across(starts_with("gnomad41_exome_AF_"), ~ as.numeric(.))) %>%
    mutate(across(starts_with("GME_"), ~ as.numeric(.)))

  # Apply pathogenicity filtering first
  filtered_variants <- annovar_output %>%
    filter(
      (SIFT_pred == "D") |
      (LRT_pred == "D") |
      (MutationTaster_pred %in% c("D", "A")) |
      (FATHMM_pred == "D") |
      (PROVEAN_pred == "D") |
      (MetaSVM_pred == "D") |
      (MetaLR_pred == "D") |
      (DANN_score_numeric > 0.9)
    ) %>%
    # Apply the MAF filtering dynamically using gnomad_GME_param
    filter(
      (gnomad41_exome_AF_afr <= gnomad_GME_param | is.na(gnomad41_exome_AF_afr)) |
      (gnomad41_exome_AF_amr <= gnomad_GME_param | is.na(gnomad41_exome_AF_amr)) |
      (gnomad41_exome_AF_asj <= gnomad_GME_param | is.na(gnomad41_exome_AF_asj)) |
      (gnomad41_exome_AF_eas <= gnomad_GME_param | is.na(gnomad41_exome_AF_eas)) |
      (gnomad41_exome_AF_fin <= gnomad_GME_param | is.na(gnomad41_exome_AF_fin)) |
      (gnomad41_exome_AF_mid <= gnomad_GME_param | is.na(gnomad41_exome_AF_mid)) |
      (gnomad41_exome_AF_nfe <= gnomad_GME_param | is.na(gnomad41_exome_AF_nfe)) |
      (gnomad41_exome_AF_remaining <= gnomad_GME_param | is.na(gnomad41_exome_AF_remaining)) |
      (gnomad41_exome_AF_sas <= gnomad_GME_param | is.na(gnomad41_exome_AF_sas)) |
      (GME_NWA <= gnomad_GME_param | is.na(GME_NWA)) |
      (GME_NEA <= gnomad_GME_param | is.na(GME_NEA)) |
      (GME_AP <= gnomad_GME_param | is.na(GME_AP)) |
      (GME_Israel <= gnomad_GME_param | is.na(GME_Israel)) |
      (GME_SD <= gnomad_GME_param | is.na(GME_SD)) |
      (GME_TP <= gnomad_GME_param | is.na(GME_TP)) |
      (GME_CA <= gnomad_GME_param | is.na(GME_CA))
    ) %>%
    filter(Gene.refGene %in% sample_genelist)  # Subset based on 'Gene.refGene'
  
  # Convert NA values back to "." for consistency with original ANNOVAR format
  filtered_variants <- filtered_variants %>%
    mutate(across(starts_with("gnomad41_exome_AF_"), ~ ifelse(is.na(.), ".", as.character(.)))) %>%
    mutate(across(starts_with("GME_"), ~ ifelse(is.na(.), ".", as.character(.))))

```

```{r}
filtered_variants

#write.csv(as.data.frame(filtered_variants),
       #   "/Users/cojulian/Desktop/Tzu_projects/Regie/cleaningup_regie/running_annovar_hg38/test_loftee_to_annovar/annovar_results_loftee_test_files/98_test_loffee.hg38_multianno.csv",
        #  row.names = FALSE)
```

## Filtered by Gene List

```{r}
otoscope_genelist <- read_csv("Otoscope_v9_072924_with_header.csv")
```


### Filtering by Otoscope

```{r}
Microtia_gl <- filtered_variants %>%
  filter(Gene.refGene %in% otoscope_genelist$Gene)

dim(Otoscope_filtered)
```


```{r}
# Define the output file path
output_path <- "/Users/cojulian/Desktop/Tzu_projects/Regie/cleaningup_regie/running_annovar_hg38/final_filtering_Feb_9/100_keepingcolumns_Microtia.csv"

# Save the filtered variants to CSV
write.csv(filtered_results, output_path, row.names = FALSE)
```






# First draft of results for hearing loss:

## Loading Gene Lists:

```{r}
Hearing_loss_gl <- read_csv("Otoscope_v9_072924_with_header.csv")

EATEF_gl <- readxl::read_excel("EATEF_genelist.xlsx")

Microtia_gl <- readxl::read_excel("Microtia_genelist.xlsx")
# Remember about special characters like RARα	| RARβ
```


Creating Data Dictionary

```{r}
first_part_data_dict <- data.frame(
  stringsAsFactors = FALSE,
                                        id = c(121,122,123,
                                               124,125,126,127,128,
                                               97,98,99,100,101,102,
                                               103,104,81,82,83,84,
                                               85,86,87,88,73,74,75,
                                               76,77,78,79,80),
                                 phenotype = c("HearingLoss",
                                               "HearingLoss","HearingLoss",
                                               "HearingLoss","HearingLoss",
                                               "HearingLoss","HearingLoss",
                                               "HearingLoss","HearingLoss","HearingLoss",
                                               "HearingLoss","Microtia",
                                               "Microtia","Microtia","EA-TEF",
                                               "EA-TEF","EA-TEF","HearingLoss",
                                               "HearingLoss","HearingLoss",
                                               "HearingLoss","HearingLoss",
                                               "HearingLoss","HearingLoss",
                                               "HearingLoss","HearingLoss","HearingLoss",
                                               "HearingLoss","HearingLoss",
                                               "HearingLoss","HearingLoss",
                                               "EA-TEF")
                        )

# Define the base directory where the files are located
base_dir <- "/Volumes/Extreme_SSD/Regie/annovar_keepingallcols_afterloftee_results/"

# Add a new column with the full file paths
first_part_data_dict$file_path <- paste0(base_dir, first_part_data_dict$id, ".hg38_multianno.txt")

# View the updated data dictionary
print(first_part_data_dict)

first_part_data_dict <- first_part_data_dict %>%
    mutate(gnomad_GME_parameter = ifelse(phenotype %in% c("Microtia", "EA-TEF"), 0.0001, 0.005)) %>%
    mutate(genelist = case_when(
        phenotype == "HearingLoss" ~ "Hearing_loss_gl",
        phenotype == "EA-TEF" ~ "EATEF_gl",
        phenotype == "Microtia" ~ "Microtia_gl",
        TRUE ~ NA_character_
    ))
```

## Converting to fst

```{r}
library(data.table)
library(fst)
library(parallel)
library(foreach)
library(doParallel)

# Set up parallel processing
num_cores <- detectCores() - 1  # Use all but one core
cl <- makeCluster(num_cores)
registerDoParallel(cl)

# List of file paths to process
file_paths <- first_part_data_dict$file_path

# Function to convert a single file to .fst format
convert_to_fst <- function(file_path) {
    # Load the .txt file using fread
    annovar_output <- fread(file_path, sep = "\t")
    
    # Define the output .fst file path
    fst_file_path <- gsub("\\.txt$", ".fst", file_path)
    
    # Save the file in .fst format
    write_fst(annovar_output, fst_file_path)
    
    # Return the path of the saved .fst file
    return(fst_file_path)
}

# Process files in parallel
fst_file_paths <- foreach(file_path = file_paths, .packages = c("data.table", "fst")) %dopar% {
    convert_to_fst(file_path)
}

# Stop the parallel cluster
stopCluster(cl)

# Print the paths of the saved .fst files
print(fst_file_paths)
```



# Function for testing one

## Loading Gene lists

```{r}
# Load gene lists into a named list
gene_lists <- list(
  "Hearing_loss_gl" = read_csv("Otoscope_v9_072924_with_header.csv") %>% dplyr::select(Gene),
  "EATEF_gl" = readxl::read_excel("EATEF_genelist.xlsx") %>% dplyr::select(Gene),
  "Microtia_gl" = readxl::read_excel("Microtia_genelist.xlsx") %>% dplyr::select(Gene)
)
```


```{r}
process_annovar_results <- function(annovar_output, sample_id, data_dict, gene_lists) {
  
  # Retrieve sample information
  sample_info <- data_dict %>% filter(id == sample_id)
  if (nrow(sample_info) == 0) stop("Sample ID not found in data dictionary")
  
  gnomad_GME_param <- sample_info$gnomad_GME_parameter
  gene_list_name <- sample_info$genelist  # Get the reference to gene list
  phenotype <- sample_info$phenotype
  # Get the actual gene list based on the reference
  sample_genelist <- gene_lists[[gene_list_name]]$Gene
  
  # Convert MAF columns to numeric, replacing "." with NA
  annovar_output <- annovar_output %>%
    mutate(DANN_score_numeric = as.numeric(replace(DANN_score, DANN_score == ".", NA))) %>%
    mutate(across(starts_with("gnomad41_exome_AF_"), ~ replace(., . == ".", NA))) %>%
    mutate(across(starts_with("GME_"), ~ replace(., . == ".", NA))) %>%
    mutate(across(starts_with("gnomad41_exome_AF_"), ~ as.numeric(.))) %>%
    mutate(across(starts_with("GME_"), ~ as.numeric(.)))

  # Apply pathogenicity filtering first
  filtered_variants <- annovar_output %>%
    filter(
      (SIFT_pred == "D") |
      (LRT_pred == "D") |
      (MutationTaster_pred %in% c("D", "A")) |
      (FATHMM_pred == "D") |
      (PROVEAN_pred == "D") |
      (MetaSVM_pred == "D") |
      (MetaLR_pred == "D") |
      (DANN_score_numeric > 0.9)
    ) %>%
    # Apply the MAF filtering dynamically using gnomad_GME_param
    filter(
      (gnomad41_exome_AF_afr <= gnomad_GME_param | is.na(gnomad41_exome_AF_afr)) |
      (gnomad41_exome_AF_amr <= gnomad_GME_param | is.na(gnomad41_exome_AF_amr)) |
      (gnomad41_exome_AF_asj <= gnomad_GME_param | is.na(gnomad41_exome_AF_asj)) |
      (gnomad41_exome_AF_eas <= gnomad_GME_param | is.na(gnomad41_exome_AF_eas)) |
      (gnomad41_exome_AF_fin <= gnomad_GME_param | is.na(gnomad41_exome_AF_fin)) |
      (gnomad41_exome_AF_mid <= gnomad_GME_param | is.na(gnomad41_exome_AF_mid)) |
      (gnomad41_exome_AF_nfe <= gnomad_GME_param | is.na(gnomad41_exome_AF_nfe)) |
      (gnomad41_exome_AF_remaining <= gnomad_GME_param | is.na(gnomad41_exome_AF_remaining)) |
      (gnomad41_exome_AF_sas <= gnomad_GME_param | is.na(gnomad41_exome_AF_sas)) |
      (GME_NWA <= gnomad_GME_param | is.na(GME_NWA)) |
      (GME_NEA <= gnomad_GME_param | is.na(GME_NEA)) |
      (GME_AP <= gnomad_GME_param | is.na(GME_AP)) |
      (GME_Israel <= gnomad_GME_param | is.na(GME_Israel)) |
      (GME_SD <= gnomad_GME_param | is.na(GME_SD)) |
      (GME_TP <= gnomad_GME_param | is.na(GME_TP)) |
      (GME_CA <= gnomad_GME_param | is.na(GME_CA))
    ) %>%
    filter(Gene.refGene %in% sample_genelist)  # Subset based on 'Gene.refGene'
  
  # Convert NA values back to "." for consistency with original ANNOVAR format
  filtered_variants <- filtered_variants %>%
    mutate(across(starts_with("gnomad41_exome_AF_"), ~ ifelse(is.na(.), ".", as.character(.)))) %>%
    mutate(across(starts_with("GME_"), ~ ifelse(is.na(.), ".", as.character(.))))
  
  
  filtered_variants <- filtered_variants %>%
    mutate(sample_id = sample_id, phenotype = phenotype)

  return(filtered_variants)
}



```


## Running for one sample


```{r}
sample_id <- 100  # Example sample

# Retrieve the file path for the sample
file_path <- first_part_data_dict %>% 
  filter(id == sample_id) %>% 
  pull(file_path)

# Read the ANNOVAR results file
annovar_output <- read_tsv(file_path)

# Process the ANNOVAR results
filtered_results <- process_annovar_results(annovar_output, sample_id, first_part_data_dict, gene_lists)

# View the filtered results
print(filtered_results)
```

Chr Post Ref Alt 1/1 and 0/1

# Hearing Loss 121

```{r}
# Define the output file path
output_path <- "/Users/cojulian/Desktop/Tzu_projects/Regie/cleaningup_regie/running_annovar_hg38/final_filtering_Feb_9/100_microtia_allinfo.csv"

# Save the filtered variants to CSV
write.csv(filtered_results, output_path, row.names = FALSE)
```

### Trying for fst all

```{r}
library(data.table)
library(fst)
library(dplyr)

# Load gene lists into a named list
gene_lists <- list(
  "Hearing_loss_gl" = read_csv("Otoscope_v9_072924_with_header.csv") %>% dplyr::select(Gene),
  "EATEF_gl" = readxl::read_excel("EATEF_genelist.xlsx") %>% dplyr::select(Gene),
  "Microtia_gl" = readxl::read_excel("Microtia_genelist.xlsx") %>% dplyr::select(Gene)
)

# Function to process a single sample and return the results
process_sample <- function(file_path, sample_id, first_part_data_dict, gene_lists) {
    # Load the .fst file
    annovar_output <- read_fst(file_path)
    
    # Process the sample using your existing function
    results <- process_annovar_results(annovar_output, sample_id, first_part_data_dict, gene_lists)
    
    return(results)
}

# Process all samples and stack the results
all_results <- lapply(1:nrow(first_part_data_dict), function(i) {
    file_path <- first_part_data_dict$file_path[i]
    sample_id <- first_part_data_dict$id[i]
    process_sample(file_path, sample_id, first_part_data_dict, gene_lists)
}) %>%
    bind_rows()  # Stack all results into a single data frame

# View the final stacked results
print(all_results)
```


### Doing it .txt

```{r}
library(data.table)
library(dplyr)
library(readr)

# Initialize an empty data frame to store the combined results
all_results <- data.frame()

# Loop through each sample in first_part_data_dict
for (i in 1:nrow(first_part_data_dict)) {
    # Get the file path and sample ID
    file_path <- first_part_data_dict$file_path[i]
    sample_id <- first_part_data_dict$id[i]
    
    # Print progress
    cat("Processing sample", sample_id, "(", i, "of", nrow(first_part_data_dict), ")...\n")
    
    # Read the ANNOVAR results file
    annovar_output <- read_tsv(file_path)
    
    # Process the ANNOVAR results
    filtered_results <- process_annovar_results(annovar_output, sample_id, first_part_data_dict, gene_lists)
    
    # Append the results to the combined data frame
    all_results <- bind_rows(all_results, filtered_results)
    
    # Print completion message
    cat("Sample", sample_id, "processed. Total variants so far:", nrow(all_results), "\n")
}

# View the final stacked results
print(all_results)
```


```{r}
write.csv(all_results, "/Users/cojulian/Desktop/Tzu_projects/Regie/cleaningup_regie/running_annovar_hg38/final_filtering_all_concatenated_Feb_13/concatenated_firstbatch.csv")
```

